<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">

<title>
    
    LLVM • ECEn 625: Compilation Strategies for High-Performance Systems
    
</title>

<!-- Bootstrap core CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<!-- Custom styles for this template -->
<link rel="stylesheet" href=/ecen625/css/main.css>

<!-- <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet"> -->
<!-- <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="https://use.typekit.net/jcn6ybb.css">

<!-- <link rel="icon" type="image/png" sizes="96x96" href=/ecen625/icon/favicon-96x96.png>
<link rel="icon" type="image/png" sizes="32x32" href=/ecen625/icon/favicon-32x32.png>
<link rel="icon" type="image/png" sizes="16x16" href=/ecen625/icon/favicon-16x16.png> -->

<script src="https://kit.fontawesome.com/d794f0229e.js" crossorigin="anonymous"></script>

</head>

<body>
  <div class="d-flex" id="wrapper">
    <!-- Sidebar -->
<div class="border-right sidebar-color" id="sidebar-wrapper">
    <div class="sidebar-sticky">
        <div class="sidebar-heading-big">
            <a href="/ecen625/">
                ECEn 625</a>
        </div>
        <!-- <div class="sidebar-heading">Pages</div> -->
        <div class="list-group list-group-flush sidebar-color">
            
            
            <a href="/ecen625/overview/"
                class="sidebar-color list-item-normal list-group-item list-group-item-action sidebar-item ">
                
                <i class="fas fa-chalkboard-teacher"></i>
                
                Overview
            </a>
            
            
            
            <a href="/ecen625/lab-setup/"
                class="sidebar-color list-item-normal list-group-item list-group-item-action sidebar-item ">
                
                <i class="fas fa-wrench"></i>
                
                Lab Setup
            </a>
            
            
            
            
            
            
            
            
            
            <a href="/ecen625/links/"
                class="sidebar-color list-item-normal list-group-item list-group-item-action sidebar-item ">
                
                <i class="fas fa-box-open"></i>
                
                Links
            </a>
            
            
            
            
            
            <a href="/ecen625/paper-reviews/"
                class="sidebar-color list-item-normal list-group-item list-group-item-action sidebar-item ">
                
                <i class="fas fa-book-open"></i>
                
                Research Papers
            </a>
            
            
            
            <a href="/ecen625/schedule/"
                class="sidebar-color list-item-normal list-group-item list-group-item-action sidebar-item ">
                
                <i class="fas fa-calendar-alt"></i>
                
                Schedule
            </a>
            
            
            
            
            
            
            <a href="https://slack.com/app_redirect?team=T01J887F8MU&channel=C01JF1N6TH8"
                class="list-item-normal list-group-item list-group-item-action sidebar-item" target="_blank"><i
                    class="fa fa-question-circle"></i>
                Slack</a>
            <!-- <a href="https://learningsuite.byu.edu/.qD2F/cid-B84_MqETGWke/calendar"
                class="list-group-item list-group-item-action bg-light sidebar-item" target="_blank">
                <i class="far fa-calendar"></i>
                Schedule
            </a> -->
        </div>

        <div class="sidebar-heading">Labs</div>
        <div class="list-group list-group-flush">
            
            <a href="/ecen625/labs/lab-graphs/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">1</span>
                Graphs & C++ Warmup
            </a>
            
            <a href="/ecen625/labs/lab-llvm/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">2</span>
                LLVM
            </a>
            
            <a href="/ecen625/labs/lab-scheduling/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">3</span>
                Scheduling
            </a>
            
            <a href="/ecen625/labs/lab-vitis-hls/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">4</span>
                Vitis HLS
            </a>
            
            <a href="/ecen625/labs/lab-vitis/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">5</span>
                Vitis Integration
            </a>
            
            <a href="/ecen625/final-project/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <i class="fa fa-microscope"></i>
                Final Project
            </a>
        </div>

        <div class="list-group list-group-flush">

        </div>

        <!-- <div class="sidebar-heading">Homeworks</div>
        <div class="list-group list-group-flush">
            
        </div> -->
    </div>
</div>
<!-- /#sidebar-wrapper -->

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar sticky-top navbar-expand-lg border-bottom">
        <button class="btn btn-brand" id="menu-toggle">
          <i class="fas fa-bars"></i>
        </button>

        <a href="" class="navbar-brand mb-0 h1 page-title-bar text-center mx-auto" id="page-title-bar"></a>

        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link btn btn-brand suggest-edits" target="_blank" rel="noopener noreferrer"
              href="https://github.com/byu-cpe/ecen625/issues/new?labels=website&title=Updates to LLVM page"><i
                class="fab fa-github"></i> Suggest
              Edits</a>
          </li>
        </ul>
      </nav>

      <div class="container">
        <article class="page lab">
    <h1 class="page-title" id="page-title">
        LLVM
        
        <a href="https://github.com/byu-cpe/ecen625_student/tree/main/lab_llvm" target="_blank"><i
                class="fab fa-github"></i></a>
        
    </h1>

    <div class="page-content">
        
        <div class="lab-toc col-md-6 col-lg-5 bg-light">
            <h4>Table of Contents</h4>
            <ul>
  <li><a href="#background">Background</a>
    <ul>
      <li><a href="#learning-outcomes">Learning Outcomes</a></li>
      <li><a href="#motivation">Motivation</a></li>
    </ul>
  </li>
  <li><a href="#getting-started">Getting Started</a>
    <ul>
      <li><a href="#required-packages">Required Packages</a></li>
      <li><a href="#running-llvm">Running LLVM</a></li>
      <li><a href="#writing-an-llvm-pass">Writing an LLVM pass</a></li>
      <li><a href="#running-your-llvm-pass">Running Your LLVM Pass</a></li>
      <li><a href="#code-organization">Code Organization</a></li>
    </ul>
  </li>
  <li><a href="#implementation">Implementation</a></li>
  <li><a href="#llvm-coding-tips">LLVM Coding Tips</a>
    <ul>
      <li><a href="#resources">Resources</a></li>
      <li><a href="#the-llvm-classes">The LLVM Classes</a></li>
      <li><a href="#debugging">Debugging</a></li>
      <li><a href="#checking-instruction-types">Checking Instruction Types</a></li>
      <li><a href="#creating-instructions">Creating Instructions</a></li>
      <li><a href="#inserting-instructions">Inserting Instructions</a></li>
      <li><a href="#replacing-instructions-or-usage">Replacing Instructions or Usage</a></li>
    </ul>
  </li>
  <li><a href="#deliverables">Deliverables</a>
      - {:.} <a href="#clock_period--20ns">CLOCK_PERIOD &lt;= 20ns</a>
      - {:.} <a href="#clock_period--5ns">CLOCK_PERIOD &lt;= 5ns</a></li>
</ul>

        </div>
        

        <h2 id="background">Background</h2>

<h3 id="learning-outcomes">Learning Outcomes</h3>
<p>The goals of this assignment are to:</p>
<ul>
  <li>Understand the benefits of applying optimizations to the IR code, prior to the standard HLS algorithms.</li>
  <li>Gain experience using LLVM to modify the IR code of a program.</li>
  <li>Practise C++ skills.</li>
</ul>

<h3 id="motivation">Motivation</h3>
<p>In this assignment you will get to write your own compiler optimization pass!  You will use LLVM (a commonly used compiler, like GCC).  The goal of the transformation will be to identify adder trees in the IR, and perform tree balancing, as shown below.  This optimization is especially helpful when targeting hardware.</p>

<p><img src="/ecen625/media/llvm/balancer_example.svg" width="600" alt="Example of adder balancer" /></p>

<p>Consider the following code (from <a href="https://github.com/byu-cpe/ecen625_student/blob/main/benchmarks/simple/simple.c">simple.c</a>) that sums the values of a 100-entry array.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int A[100];
for (int i = 0; i &lt; 100; i++)
    sum += A[i];
</code></pre></div></div>

<p>To implement this in hardware, we could build an RTL circuit with a state machine that repeatedly read a value from memory, added it to a sum register, and incremented the address.  We could also use an HLS tool to build that RTL for us, and it may take a similar approach if no optimizations were applied.</p>

<p>The code could be made much faster by performing multiple loop iterations in parallel.  This is referred to as <em>loop unrolling</em>.</p>

<p>The following code, (from <a href="https://github.com/byu-cpe/ecen625_student/tree/main/benchmarks/simple_unrolled_partitioned">simple_unrolled_partitioned/simple.c</a>), shows the array summation  unrolled by a factor of 10.  One issue with unrolling like this is that it is usually not possible to load 10 values from memory at once.  If values are loaded sequentially, there will be little to no benefits to loop unrolling.  To get around this problem, the code also includes <em>memory banking</em>, where the  <code class="language-plaintext highlighter-rouge">A</code> array is split into 5 equal sized arrays, <code class="language-plaintext highlighter-rouge">A1</code>, <code class="language-plaintext highlighter-rouge">A2</code>, <code class="language-plaintext highlighter-rouge">A3</code>, <code class="language-plaintext highlighter-rouge">A4</code>, and <code class="language-plaintext highlighter-rouge">A5</code>.  Each of these can be placed in a separate dual-ported memory, allowing us to read 10 values from memory simultaneously.  (<em>While this C code implements loop unrolling and memory banking manually, modern HLS tools will do this for you when requested.  Certain tools may even be smart enough to do it automatically.</em>)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int A1[20];
int A2[20];
int A3[20];
int A4[20];
int A5[20];

for (int i = 0; i &lt; 20; i += 2) {
    sum += A1[i] + A1[i + 1] + 
           A2[i] + A2[i + 1] + 
           A3[i] + A3[i + 1] +
           A4[i] + A4[i + 1] + 
           A5[i] + A5[i + 1];
</code></pre></div></div>

<p>The above code will end up creating a cascading adder tree as shown in the left side of the figure above.  We would like to automatically optimize the IR to balance the adder tree, producing a structure similar to the right-hand side of the figure above.  This optimization can improve the critical path of the resulting hardware, or if timing constraints are imposed, reduce the latency of each loop iteration.</p>

<h2 id="getting-started">Getting Started</h2>

<h3 id="required-packages">Required Packages</h3>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install llvm-12 llvm-12-dev libclang-common-12-dev clang-12 liblpsolve55-dev texlive-latex-base texlive-pictures
</code></pre></div></div>

<h3 id="running-llvm">Running LLVM</h3>
<p>Your scheduler is going to run as an LLVM pass.  This means that after you compile a C program to LLVM IR, you are doing to run your pass on the LLVM IR.</p>

<p>You are given a few different C programs in the <code class="language-plaintext highlighter-rouge">benchmarks</code> directory.  You can <code class="language-plaintext highlighter-rouge">cd</code> into these benchmark directories, and run <code class="language-plaintext highlighter-rouge">make &lt;target&gt;</code> to compile them.  Try running just  <code class="language-plaintext highlighter-rouge">clang</code> (C front-end compiler) to compile the <code class="language-plaintext highlighter-rouge">simple</code> benchmark your C code into LLVM IR.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd benchmarks/simple
make clang
</code></pre></div></div>

<p>The provided <a href="https://github.com/byu-cpe/ecen625_student/blob/main/benchmarks/simple_unrolled_partitioned/Makefile">Makefile</a> will first run <code class="language-plaintext highlighter-rouge">clang</code> to produce a binary IR file (<code class="language-plaintext highlighter-rouge">simple.clang.bc</code>), after which it will run <code class="language-plaintext highlighter-rouge">llvm-dis</code> to dissassemble the binary into human readable IR (<code class="language-plaintext highlighter-rouge">simple.clang.ll</code>)</p>

<p>Look through the LLVM IR file and try to understand how it implements the <code class="language-plaintext highlighter-rouge">simple.c</code> program.  Then go to the <code class="language-plaintext highlighter-rouge">simple_unrolled_partitioned</code> bechmark and look at the IR that program produces.  Make sure you can find the long sequence of cascaing add instructions.</p>

<h3 id="writing-an-llvm-pass">Writing an LLVM pass</h3>

<p>While you could download the LLVM source code, and add your pass code to it, compiling LLVM from source can take 20-30 minutes.  Instead, we are going to develop your pass <em>out-of-tree</em>.  Above you should have installed the LLVM binaries using the Ubuntu package manger.  We are going to compile your pass code into a shared library object (.so) file, than can be loaded by LLVM at runtime.</p>

<p>Your pass code and <a href="https://github.com/byu-cpe/ecen625_student/blob/main/lab_llvm/src/CMakeLists.txt">CMakeLists.txt</a> file are provided in the <code class="language-plaintext highlighter-rouge">src</code> directory. For this assignment we will be using a <code class="language-plaintext highlighter-rouge">FunctionPasfs</code> in LLVM.  That is, it is a transformation pass that modifies code contained with a single function.</p>

<p>Take a look at <a href="https://github.com/byu-cpe/ecen625_student/blob/main/lab_llvm/src/AdderTreeBalancer.cpp">AdderTreeBalancer.cpp</a>, specifically these lines:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>char AdderTreeBalancer::ID = 0;
static RegisterPass&lt;AdderTreeBalancer&gt; X("ATB_625", "Adder Tree Balancer Pass");

bool AdderTreeBalancer::runOnFunction(Function &amp;f) {
	...
}
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">RegisterPass</code> registers your pass with LLVM and specifies that it can be called using the <code class="language-plaintext highlighter-rouge">-ATB_625</code> flag.  The <code class="language-plaintext highlighter-rouge">AdderTreeBalancer</code> class is a subclass of <code class="language-plaintext highlighter-rouge">llvm::FunctionPass </code>, meaning this pass should be called for every <em>Function</em> in the code.  Specifically, the <code class="language-plaintext highlighter-rouge">runOnFunction()</code> function will be called for each <em>Function</em>.</p>

<p>You can also create passes that operate at different scopes, including Module (entire C program), Loop, Region, and more.  More information on these types of passes can be found at <a href="https://releases.llvm.org/12.0.0/docs/WritingAnLLVMPass.html">WritingAnLLVMPass</a>.</p>

<p>Go ahead and compile the provided code:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd lab_llvm/build
cmake ../src
make
</code></pre></div></div>

<p>This will produce your library <code class="language-plaintext highlighter-rouge">ATB_625.so</code>.</p>

<h3 id="running-your-llvm-pass">Running Your LLVM Pass</h3>

<p>The benchmark Makfile contains several targets that can be used to run your AdderTreeBalancer pass.:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">make atb</code>: This will run your pass, followed by dead code elimination (which will remove unused instructions).  This will produce a file <code class="language-plaintext highlighter-rouge">*.atb.ll</code> which contains the LLVM IR after your pass is run.</li>
  <li><code class="language-plaintext highlighter-rouge">make atb_check</code>: Since you are modifying the original program, you will want to double check that you haven’t broken the functionality. This target will first run the <code class="language-plaintext highlighter-rouge">atb</code> target to produce the transformed IR, followed by running it using the LLVM emulator (<code class="language-plaintext highlighter-rouge">lli</code>).  The <code class="language-plaintext highlighter-rouge">simple_unrolled_partitioned</code> and <code class="language-plaintext highlighter-rouge">shared_add_tree</code> benchmarks both print <strong>CORRECT</strong> or <strong>ERROR</strong>, depending on whether the sum is correct.</li>
  <li><code class="language-plaintext highlighter-rouge">make atb_schedule</code>: This will run the <code class="language-plaintext highlighter-rouge">atb</code> pass, and then pass the new LLVM IR to an HLS scheduler, which will determine which instructions can run in each cycle in hardware.  This will produce PDF files which display the schedule of each IR instructions.  If you implement the pass correctly, you will see improvements made to the produced schedule.</li>
  <li><code class="language-plaintext highlighter-rouge">make schedule</code>: This will run the HLS schedule without your ATB pass.</li>
</ul>

<h3 id="code-organization">Code Organization</h3>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">lab_llvm/src/AdderTreeBalancer.cpp/.h</code> – You will add all your code for this assignment in theses files.  You are welcome to add additional source files if you like.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">benchmarks</code> – This contains some C programs to test your code.  You are welcome to test your pass with any design in this folder (or create your own test designs); however, only the <code class="language-plaintext highlighter-rouge">simple_unrolled_partitioned</code> and <code class="language-plaintext highlighter-rouge">shared_add_tree</code> designs have large adder trees.  The <code class="language-plaintext highlighter-rouge">shared_add_tree</code> design has an adder tree used by another adder tree, so it’s useful to test that you are handling that correctly (see the first tip listed later on this page).</p>
  </li>
</ul>

<h2 id="implementation">Implementation</h2>

<p>How you code the tree balancer is up to you.</p>

<p>You probably want to follow this general approach:</p>
<ol>
  <li>Look through the Instructions in the BasicBlock for add instructions, treat this instruction <code class="language-plaintext highlighter-rouge">I</code> as the root of an adder tree, and collect a list of inputs to this adder tree.</li>
  <li>Create a balanced adder tree with these inputs, and add these new <code class="language-plaintext highlighter-rouge">add</code> instructions to the BasicBlock.</li>
  <li>Replace uses of the root adder instruction, <code class="language-plaintext highlighter-rouge">I</code>, with the output of your newly created adder tree.</li>
  <li>Repeat until all adder trees are balanced.</li>
</ol>

<p>Some tips with this approach:</p>
<ul>
  <li>When recursively visiting adders, you need to make sure the output of an intermediate node is not used elsewhere in the code.  You can do this by checking that the number of uses is one (<code class="language-plaintext highlighter-rouge">Value.getNumUses()</code>).  The reason for this is that all of these instructions will be deleted and replaced by your adder tree; only the final output of the adder tree can be used multiple places in the code.</li>
  <li>The inputs to your adder tree may be instructions, constants, function arguments, etc.  You should use the LLVM <code class="language-plaintext highlighter-rouge">Value</code> to keep track of the inputs.</li>
  <li>You will need to add all of your newly created addition instructions to the BasicBlock.  Make sure you add them in a valid position, and order (ie. the final addition in your tree should be located before any uses, and adder nodes in your tree should be in a valid ordering).  If you are smart in how you create your adder tree, you can build a list of add instructions that are already in the correct order.  You can then add all of these add instructions immediately before instruction <code class="language-plaintext highlighter-rouge">I</code> (as described in Step 3 of the technique above).</li>
  <li>You don’t need to delete the adder instructions you are replacing with your tree.  As long as you complete Step 3, these additions will become dead code.  Since dead code elimination is performed after your pass, these instructions will automatically be removed. Likewise, if you only complete Step 1 and 2, and never use your new adder tree, dead code elimination will remove it.</li>
  <li>In Step 1 you are iterating over the BasicBlock.  However, if you end up inserting an adder tree, you are modifying the very data structure you are iterating over.  You cannot continue iterating at this point.  Either exit out of the iteration and start over, or keep a track of pending changes and wait until the iteration is complete before actually making the changes.</li>
  <li>You will probably want to keep track of which additions are part of your balanced adder trees, and then skip over them in Step 1.  Otherwise you can end up in an endless loop of replacing your balanced adder trees with new identical adder trees.  <strong>The other benefit of this approach is that you don’t need to check whether existing adder networks in the user’s code are balanced or not.  Simply replace them with a balanced adder tree regardless of whether the existing structure is already optimal.</strong></li>
</ul>

<h2 id="llvm-coding-tips">LLVM Coding Tips</h2>
<p>Here are a few suggestions to help you with the LLVM API.  If you are still unsure how you do something in LLVM, please post on Slack and I would be happy to help you out.</p>

<h3 id="resources">Resources</h3>

<p>We are using LLVM version 12.0.  The documentation can be found at <a href="https://releases.llvm.org/12.0.0/docs/">https://releases.llvm.org/12.0.0/docs/</a>.  Some useful pages:</p>
<ul>
  <li>The <a href="https://releases.llvm.org/12.0.0/docs/LangRef.html">Language Reference Manual</a> describes each LLVM IR instruction.</li>
  <li>The <a href="https://releases.llvm.org/12.0.0/docs/ProgrammersManual.html">Programmers Manual</a> is a good place to start reading about coding in LLVM.</li>
</ul>

<h3 id="the-llvm-classes">The LLVM Classes</h3>

<p>LLVM is an object-oriented code base, with <strong>lots</strong> of inheritance.  You can find auto-generated documentation for each class.  For example, check out the <a href="https://llvm.org/doxygen/classllvm_1_1Instruction.html">Instruction</a> class.  Usually the quickest way to find these documentation pages is a google search.</p>

<p>Take a look at the illustrated class hierarchy on that webpage.  You will see that <code class="language-plaintext highlighter-rouge">Instruction</code> inherits from <code class="language-plaintext highlighter-rouge">User</code>, which in turn inherits from <code class="language-plaintext highlighter-rouge">Value</code>.  <strong>From LLVM programmers manual</strong>:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Value</code>: The Value class is the most important class in the LLVM Source base. It represents a typed value that may be used (among other things) as an operand to an instruction. There are many different types of Values, such as Constants, Arguments. Even Instructions and Functions are Values.</li>
  <li><code class="language-plaintext highlighter-rouge">User</code>: The User class is the common base class of all LLVM nodes that may <em>refer</em> to other Values. It exposes a list of “Operands” that are all of the Values that the User is referring to. The User class itself is a subclass of Value.</li>
  <li><code class="language-plaintext highlighter-rouge">Instruction</code>: The Instruction class is the common base class for all LLVM instructions. It provides only a few methods, but is a very commonly used class. The primary data tracked by the Instruction class itself is the opcode (instruction type) and the parent BasicBlock the Instruction is embedded into. To represent a specific type of instruction, one of many subclasses of Instruction are used.</li>
</ul>

<p>In this assignment you will be frequently using the <code class="language-plaintext highlighter-rouge">add</code> instruction.  This instruction is of type <code class="language-plaintext highlighter-rouge">BinaryOperator</code> (a subclass of Instruction), which is used by all instructions that operate on two pieces of data (thus Binary).  To check if it is an adder, you can call <code class="language-plaintext highlighter-rouge">getOpcode()</code>, which for an adder will return the constant <code class="language-plaintext highlighter-rouge">Instruction::Add</code>.</p>

<h3 id="debugging">Debugging</h3>

<p>In LLVM, you can use <code class="language-plaintext highlighter-rouge">outs() &lt;&lt;</code> to print out just about any class you want.  You can print Values, Users, Instructions, BasicBlocks, Functions, etc.  Just keep in mind that to print an object you should use the object itself, not a pointer to the object.  If you have a pointer, you should dereference it, such as:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instruction * I = ...;
outs() &lt;&lt; *I &lt;&lt; "\n";
</code></pre></div></div>

<p>You can also use <code class="language-plaintext highlighter-rouge">report_fatal_error("message")</code> to stop execution immediately and report an error.</p>

<h3 id="checking-instruction-types">Checking Instruction Types</h3>

<p>When iterating through the <code class="language-plaintext highlighter-rouge">Instruction</code> objects in a BasicBlock, you may need to check the type of Instruction.  This can be done a few different ways.  For example, here are a few ways to check if an <code class="language-plaintext highlighter-rouge">Instruction</code> is a <code class="language-plaintext highlighter-rouge">BinaryOperator</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instruction * I;
if (isa&lt;BinaryOperator&gt;(I)) {
   // I is a BinaryOperator
}
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Instruction * I;
if (BinaryOperator * bo = dyn_cast&lt;BinaryOperator&gt;(I)) {
    dbgs() &lt;&lt; "Instruction is a binary operator with opcode " &lt;&lt; bo-&gt;getOpcode() &lt;&lt; "\n";
}
</code></pre></div></div>

<h3 id="creating-instructions">Creating Instructions</h3>

<p>Generally to create new instructions, you do not call the constructor directly, but rather call a static class method.  For example, one way to create a new <code class="language-plaintext highlighter-rouge">add</code> instruction:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Value * in1 = ...
Value * in2 = ...
BinaryOperator * bo = BinaryOperator::Create(BinaryOperator::Add, in1, in2, "myInsnName", (Instruction*) NULL);
</code></pre></div></div>

<p>The last argument in this case is a pointer to an existing <code class="language-plaintext highlighter-rouge">Instruction</code>, and the new Instruction will be inserted preceeding it. If you pass in NULL, the new instruction is not inserted into the code, but you will need to do so later.</p>

<h3 id="inserting-instructions">Inserting Instructions</h3>
<p>There are many ways to insert instructions into a basic block.  These are discussed in the <a href="https://releases.llvm.org/12.0.0/docs/ProgrammersManual.html#creating-and-inserting-new-instructions">Programmers Manual</a>, although I have found this is somewhat out of date. In particular, the pages gives this example, but it is missing the required <code class="language-plaintext highlighter-rouge">-&gt;getIterator()</code> on the existing Instruction.</p>

<h3 id="replacing-instructions-or-usage">Replacing Instructions or Usage</h3>

<p>If you want to swap out an Instruction for a different one, there are a few options:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void ReplaceInstWithInst(Instruction *From, Instruction *To);
</code></pre></div></div>
<p>This adds the instruction <code class="language-plaintext highlighter-rouge">To</code> to a basic block, such that it is positioned immediately before <code class="language-plaintext highlighter-rouge">From</code>, replaces all uses of <code class="language-plaintext highlighter-rouge">From</code> with <code class="language-plaintext highlighter-rouge">To</code> and then removes <code class="language-plaintext highlighter-rouge">From</code>.  <strong>Important</strong>: This function will add the new <code class="language-plaintext highlighter-rouge">To</code> instruction to the basic block, so make sure you have not already added it.  If you have, you can use this method instead:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/// Replace all uses of an instruction (specified by BI) with a value, then
/// remove and delete the original instruction.
void ReplaceInstWithValue(BasicBlock::InstListType &amp;BIL,
                          BasicBlock::iterator &amp;BI, Value *V);
</code></pre></div></div>
<p>This replaces all uses of the instruction referenced by the iterator <code class="language-plaintext highlighter-rouge">BI</code> with the Value <code class="language-plaintext highlighter-rouge">V</code>, and then removes the instruction referenced by the iterator <code class="language-plaintext highlighter-rouge">BI</code>.	This is similar to <code class="language-plaintext highlighter-rouge">ReplaceInstWithInst</code>, except that it doesn’t add <code class="language-plaintext highlighter-rouge">V</code> into the code anywhere – it assumes this was already done.  It also requires you to pass in an interator to the old instruction, rather than a pointer to the instruction itself.  This can easily be done with code such as the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BinaryOperator * oldAdder = ...;
BinaryOperator * adderTree = ...;
BasicBlock::iterator BI(oldAdder);
ReplaceInstWithValue(BB.getInstList(), BI, adderTree);
</code></pre></div></div>

<h2 id="deliverables">Deliverables</h2>

<ol>
  <li>
    <p>Submit your code on Github using the tag <code class="language-plaintext highlighter-rouge">lab2_submission</code></p>
  </li>
  <li>
    <p>Include a 1-page PDF document (<code class="language-plaintext highlighter-rouge">lab_llvm/report.pdf</code>) that includes the following:</p>
  </li>
</ol>

<p>For the <code class="language-plaintext highlighter-rouge">simple_unrolled_partitioned</code> program, obtain the missing results in the following tables (there are 8 cells to fill in), and include the completed tables in your report.  You can find the HLS schedule by looking at the <code class="language-plaintext highlighter-rouge">main.schedule.rpt</code> file, and the longest path by looking at the <code class="language-plaintext highlighter-rouge">main.timing.rpt</code> file, which lists the longest path for each BasicBlock.  The cycles per loop iteration can be obtained from the scheduling report (or Gantt chart PDF), by manually looking at how many states are created for the summation loop.  The total summation time is simply the product of the longest path, loop iteration latency, and number of iterations (10).</p>

<h4 id="clock_period--20ns">CLOCK_PERIOD &lt;= 20ns</h4>

<table>
  <thead>
    <tr>
      <th> </th>
      <th style="text-align: right">Longest Path (ns)</th>
      <th style="text-align: right">Loop iteration latency</th>
      <th style="text-align: right">Summation Time (ns)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>WITHOUT TreeBalancer</td>
      <td style="text-align: right">17.5</td>
      <td style="text-align: right">4</td>
      <td style="text-align: right">700</td>
    </tr>
    <tr>
      <td>WITH TreeBalancer</td>
      <td style="text-align: right"> </td>
      <td style="text-align: right"> </td>
      <td style="text-align: right"> </td>
    </tr>
    <tr>
      <td>Speedup</td>
      <td style="text-align: right">-</td>
      <td style="text-align: right">-</td>
      <td style="text-align: right">?x</td>
    </tr>
  </tbody>
</table>

<h4 id="clock_period--5ns">CLOCK_PERIOD &lt;= 5ns</h4>

<table>
  <thead>
    <tr>
      <th> </th>
      <th style="text-align: right">Longest Path (ns)</th>
      <th style="text-align: right">Loop iteration latency</th>
      <th style="text-align: right">Summation Time (ns)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>WITHOUT TreeBalancer</td>
      <td style="text-align: right">5.0</td>
      <td style="text-align: right">12</td>
      <td style="text-align: right">600</td>
    </tr>
    <tr>
      <td>WITH TreeBalancer</td>
      <td style="text-align: right"> </td>
      <td style="text-align: right"> </td>
      <td style="text-align: right"> </td>
    </tr>
    <tr>
      <td>Speedup</td>
      <td style="text-align: right">-</td>
      <td style="text-align: right">-</td>
      <td style="text-align: right">?x</td>
    </tr>
  </tbody>
</table>


    </div>
</article>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap core JavaScript -->
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
<script src=/ecen625/js/jquery.visible.min.js></script>

<!-- Menu Toggle Script -->
<script>
    $("#menu-toggle").click(function (e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });

    var prevVisible = $('#page-title').visible();

    $(window).scroll(function () {
        currentVisible = $('#page-title').visible()
        if (prevVisible && !currentVisible) {
            console.log("Do something!");
            $("#page-title-bar").html($('#page-title').text());
        }

        if (!prevVisible && currentVisible) {
            $("#page-title-bar").html("")
        }

        prevVisible = currentVisible;
    });

</script>

</body>

</html>